---
title: "TIL 2025-06-27"
summary: "TIL 2025-06-27"
date: "June 30 2025"
draft: false
tags:
  - TIL
---

## 1\. 데이터 설명

![##_Image|kage@YDjPe/btsOVvXl8ZE/AAAAAAAAAAAAAAAAAAAAAL-XtPXypGsZ2sijeK1dgmC1OQQEMqnbGKVd7XCEonpo/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1751295599&allow_ip=&allow_referer=&signature=ksMCCATNKTuGIOnjIaTe0WDD%2BGU%3D|CDM|1.3|{"originWidth":777,"originHeight":803,"style":"alignCenter"}_##](1.png)

## 2\. 문제

![##_Image|kage@cx68l8/btsOUG66ID4/AAAAAAAAAAAAAAAAAAAAANkb62NsRGfQm_ygFxo_HjihuBfUU59lsInKe4CpyB_c/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1751295599&allow_ip=&allow_referer=&signature=%2FspwjsIzm7KieDZU6Hd%2Bc5QEFUw%3D|CDM|1.3|{"originWidth":1083,"originHeight":1054,"style":"alignCenter"}_##](2.png)

## 3\. 해결과정

### 문제 1.

1.  customerID를 사용해 두 개의 테이블을 join한다.
2.  고객별로 주문 건수와 총 주문 금액을 조회해야 하니 group by customerName을 사용한다.
3.  주문 건수는 count(), 총 주문 금액은 sum()을 사용한다.
4.  left join을 통해 주문 한 적이 없는 고객도 결과에 포함하도록 한다.
5.  coalesce()를 통해 주문이 없는 경우 주문 금액을 0으로 만든다.

### 문제 2.

1.  cutomerID를 사용해 두 개의 테이블을 join한다.
2.  국가별 -> 사용자별로 주문 금액 순위를 정해야 하므로 group by country, customerName을 추갛나다.
3.  이 때 sum()을 사용하여 주문 금액의 합을 구한다.
4.  rank()를 사용하는데, partition by에 country로 설정하고 order by sum(totalAmount) desc를 추가하여 나라별 주문 금액 내림차순으로 rank 컬럼을 만든다.
5.  4번에서 만든 쿼리의 결과를 from의 쿼리로 사용하고 where에서 rank 컬럼이 1인 로우들만 뽑는다.

## 4\. 정답 및 결과

### 문제 1.

```sql
select c.CustomerName , count(*) as 'OrderCount',
       coalesce(sum(o.TotalAmount), 0) as 'TotalSpent'
from orders o left join customers c on o.CustomerID = c.CustomerID
group by c.CustomerName
```

![##_Image|kage@s2xj1/btsOVCPRam1/AAAAAAAAAAAAAAAAAAAAAIE7TM2EuH_7Cx8S-pPIZBDRxuSwkwmY8gX57CJbVT97/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1751295599&allow_ip=&allow_referer=&signature=fykgVyxbiqrIUPPFPbTJ3mzN7P8%3D|CDM|1.3|{"originWidth":651,"originHeight":170,"style":"alignCenter"}_##](3.png)

### 문제 2.

```sql
select Country,
       CustomerName as 'Top_Customer',
       sumTotalAmount as 'Top_Spent'
from (
select
    c.Country,
    c.CustomerName,
    sum(o.TotalAmount) as 'sumTotalAmount',
    rank() OVER(PARTITION BY c.Country ORDER BY SUM(o.TotalAmount) DESC) as 'rankByCountry'
from
    Customers c
join
    Orders o on c.CustomerID = o.CustomerID
group by
    c.Country, c.CustomerName
) as sq
where rankByCountry = 1
order by Country desc;
```

![##_Image|kage@Iwpyd/btsOUxaEscp/AAAAAAAAAAAAAAAAAAAAAHalU_HlCnw2M_SELRgHNjighLEswv5KNmS-mbiXrZum/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1751295599&allow_ip=&allow_referer=&signature=rJ1%2BZ7IvzdiqscmVw9PqZ50ElDI%3D|CDM|1.3|{"originWidth":625,"originHeight":139,"style":"alignCenter"}_##](4.png)
